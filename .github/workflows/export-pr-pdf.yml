name: Exportar Acta de Cierre de Sprint a PDF

on:
  pull_request:
    types: [closed]

jobs:
  generar-pdf:
    if: contains(github.event.pull_request.head.ref, 'sprint') # ✅ Validación del branch origen
    runs-on: ubuntu-latest
    steps:
      - name: Instalar dependencias
        run: sudo apt-get update && sudo apt-get install -y pandoc jq

      - name: Instalar GitHub CLI
        run: |
          type -p curl >/dev/null || sudo apt-get install curl -y
          curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | sudo dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg
          sudo chmod go+r /usr/share/keyrings/githubcli-archive-keyring.gpg
          echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | sudo tee /etc/apt/sources.list.d/github-cli.list > /dev/null
          sudo apt-get update && sudo apt-get install gh -y

      - name: Autenticación GH CLI
        run: gh auth setup-git
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Obtener contenido del PR
        run: |
          echo "Extrayendo contenido del Pull Request..."
          gh pr view ${{ github.event.pull_request.number }} --json body,title > pr.json
          jq -r '.title, .body' pr.json > acta-cierre-sprint.md

      - name: Convertir a PDF
        run: pandoc acta-cierre-sprint.md -o acta-cierre-sprint.pdf

      - name: Subir PDF como artefacto
        uses: actions/upload-artifact@v3
        with:
          name: acta-cierre-sprint
          path: acta-cierre-sprint.pdf