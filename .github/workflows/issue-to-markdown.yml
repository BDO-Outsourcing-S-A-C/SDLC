name: Issue → Markdown (docs)

on:
  issues:
    types: [opened, edited, labeled]

permissions:
  contents: write
  issues: write

jobs:
  generate-md:
    if: |
      contains(join(github.event.issue.labels.*.name, ','), 'tipo:requerimiento') ||
      contains(join(github.event.issue.labels.*.name, ','), 'tipo:cambio') ||
      contains(join(github.event.issue.labels.*.name, ','), 'tipo:prueba')
    runs-on: ubuntu-latest

    steps:
      - name: Generar/actualizar Markdown desde el Issue
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const issue  = context.payload.issue;
            const owner  = context.repo.owner;
            const repo   = context.repo.repo;
            const body   = issue.body || '';
            const labels = (issue.labels || []).map(l => l.name);

            // ---------- helpers ----------
            function getSection(label, variants = []) {
              const all = [label].concat(variants);
              for (const lab of all) {
                const re = new RegExp(`^###\\s*${lab}\\s*\\n+([\\s\\S]*?)(?=^###\\s|\\Z)`, 'gmi');
                const m = re.exec(body);
                if (m && m[1]) return m[1].trim();
              }
              return '';
            }
            function slugify(s) {
              return (s || '')
                .normalize('NFD').replace(/[\u0300-\u036f]/g,'')
                .toLowerCase().replace(/[^a-z0-9]+/g,'-')
                .replace(/(^-|-$)/g,'').substring(0,80);
            }
            function yyyymmdd(d) {
              const y = d.getFullYear();
              const m = String(d.getMonth()+1).padStart(2,'0');
              const day = String(d.getDate()).padStart(2,'0');
              return `${y}-${m}-${day}`;
            }

            // ---------- clasifica ----------
            let tipo, folder, codePrefix;
            if (labels.includes('tipo:requerimiento')) {
              tipo = 'Requerimiento'; folder = 'docs/requerimientos'; codePrefix = 'RQ';
