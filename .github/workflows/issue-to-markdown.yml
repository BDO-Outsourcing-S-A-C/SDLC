name: Issue → Markdown (docs)

on:
  issues:
    types: [opened, edited, labeled]

permissions:
  contents: write
  issues: write

jobs:
  generate-md:
    if: |
      contains(join(github.event.issue.labels.*.name, ','), 'tipo:requerimiento') ||
      contains(join(github.event.issue.labels.*.name, ','), 'tipo:cambio') ||
      contains(join(github.event.issue.labels.*.name, ','), 'tipo:prueba')
    runs-on: ubuntu-latest

    steps:
      - name: Generar/actualizar Markdown desde el Issue
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const issue  = context.payload.issue;
            const owner  = context.repo.owner;
            const repo   = context.repo.repo;
            const body   = issue.body || '';
            const labels = (issue.labels || []).map(l => l.name);

            // ---------- helpers ----------
            function getSection(label, variants = []) {
              const all = [label].concat(variants);
              for (const lab of all) {
                const re = new RegExp(`^###\\s*${lab}\\s*\\n+([\\s\\S]*?)(?=^###\\s|\\Z)`, 'gmi');
                const m = re.exec(body);
                if (m && m[1]) return m[1].trim();
              }
              return '';
            }
            function slugify(s) {
              return (s || '')
                .normalize('NFD').replace(/[\u0300-\u036f]/g,'')
                .toLowerCase().replace(/[^a-z0-9]+/g,'-')
                .replace(/(^-|-$)/g,'').substring(0,80);
            }
            function yyyymmdd(d) {
              const y = d.getFullYear();
              const m = String(d.getMonth()+1).padStart(2,'0');
              const day = String(d.getDate()).padStart(2,'0');
              return `${y}-${m}-${day}`;
            }

            // ---------- clasifica ----------
            let tipo, folder, codePrefix;
            if (labels.includes('tipo:requerimiento')) {
              tipo = 'Requerimiento'; folder = 'docs/requerimientos'; codePrefix = 'RQ';
            } else if (labels.includes('tipo:cambio')) {
              tipo = 'Control de Cambio'; folder = 'docs/cambios'; codePrefix = 'CC';
            } else if (labels.includes('tipo:prueba')) {
              tipo = 'Prueba'; folder = 'docs/pruebas/actas'; codePrefix = 'PRB';
            } else {
              core.setFailed('Issue sin etiqueta tipo:* esperada'); return;
            }

            // ---------- extrae campos de Issue Form ----------
            const sistema       = getSection('Sistema');
            const modulo        = getSection('Módulo',['Modulo']);
            const descripcion   = getSection('Descripción general',['Descripción','Descripcion','Descripción general del cambio']);
            const justificacion = getSection('Justificación',['Justificacion','Justificación (negocio/operativa/seguridad)']);
            const impacto       = getSection('Análisis de impacto',['Analisis de impacto','Impacto']);
            const solicitante   = getSection('Solicitante');
            const autorizado    = getSection('Autorizado por',['Autorizado']);
            const esfuerzo      = getSection('Esfuerzo estimado (horas)',['Esfuerzo','Esfuerzo estimado']);
            const costo         = getSection('Costo asociado (S/ o USD)',['Costo','Costo asociado']);
            const intellisign   = getSection('Aprobación (Intellisign URL/ID)',['Intellisign','Aprobación']);
            const criterios     = getSection('Criterios de Aceptación',['Criterios de Aceptacion']);
            const rf            = getSection('Requisitos Funcionales',['Requisitos funcionales']);
            const nfr           = getSection('Requisitos No Funcionales',['Requisitos no funcionales']);
            const objetivo      = getSection('Objetivo de la prueba',['Objetivo']);
            const alcance       = getSection('Alcance y preparación',['Alcance','Preparación','Preparacion']);
            const casos         = getSection('Casos de prueba');
            const resultados    = getSection('Resultados y evidencias',['Resultados']);
            const incidencias   = getSection('Incidencias/Bugs detectados',['Incidencias','Bugs']);

            // ---------- código y path ----------
            const year   = new Date(issue.created_at).getFullYear();
            const codigo = `${codePrefix}-${year}-${String(issue.number).padStart(4,'0')}`;
            const slug   = slugify(issue.title.replace(/^((RQ|CC|PRB)\s*:)?\s*/i,''));
            const fileDt = yyyymmdd(new Date(issue.created_at));
            const file   = `${fileDt}__${codigo}__${slug || 'item'}.md`;
            const path   = `${folder}/${file}`;

            // ---------- front-matter ----------
            let frontmatterLines = [];
            if (tipo === 'Requerimiento') {
              frontmatterLines = [
                '---',
                `tipo: "Requerimiento"`,
                `codigo: "${codigo}"`,
                `sistema: "${sistema}"`,
                `modulo: "${modulo}"`,
                `solicitante: "${solicitante}"`,
                `prioridad: ""`,
                `estado: "En Análisis"`,
                `issue: ${issue.html_url}`,
                '---'
              ];
            } else if (tipo === 'Control de Cambio') {
              frontmatterLines = [
                '---',
                `tipo: "Control de Cambio"`,
                `codigo: "${codigo}"`,
                `sistema: "${sistema}"`,
                `modulo: "${modulo}"`,
                `solicitante: "${solicitante}"`,
                `autorizado_por: "${autorizado}"`,
                `esfuerzo_horas: ${Number(esfuerzo) || 0}`,
                `costo_monetario: "${costo || ''}"`,
                `intellisign: "${intellisign || ''}"`,
                `estado: "En Análisis"`,
                `issue: ${issue.html_url}`,
                '---'
              ];
            } else {
              frontmatterLines = [
                '---',
                `tipo: "Prueba"`,
                `codigo: "${codigo}"`,
                `sistema: "${sistema}"`,
                `modulo: "${modulo}"`,
                `estado: "Planificada"`,
                `issue: ${issue.html_url}`,
                '---'
              ];
            }
            const fm = frontmatterLines.join('\n');

            // ---------- cuerpo por tipo ----------
            let bodyMd = '';
            if (tipo === 'Requerimiento') {
              bodyMd = [
                `# Requerimiento: ${issue.title}`,
                '',
                '## 1. Descripción',
                descripcion || '',
                '',
                '## 2. Alcance',
                alcance || '',
                '',
                '## 3. Requisitos Funcionales',
                rf || '- RF-01: …',
                '',
                '## 4. Requisitos No Funcionales',
                nfr || '- Seguridad: …',
                '',
                '## 5. Criterios de Aceptación',
                criterios || '- [ ] Dado/Cuando/Entonces …',
                '',
                '## 6. Dependencias',
                '- (Completar)',
                '',
                '## 7. Evidencias',
                '- (Mockups/diagramas)',
                '',
                '## 8. Trazabilidad',
                '- Cambios: (CC-…)',
                '- Casos de prueba: (CP-…)',
                '- PRs: (#…)',
                ''
              ].join('\n');
            } else if (tipo === 'Control de Cambio') {
              bodyMd = [
                `# Control de Cambios: ${issue.title}`,
                '',
                '## 1. Descripción',
                descripcion || '',
                '',
                '## 2. Análisis de Impacto',
                impacto || '',
                '',
                '## 3. Alcance',
                alcance || '',
                '',
                '## 4. Plan de Trabajo',
                '- Desarrollo: …',
                '- QA: …',
                '- Producción: …',
                '',
                '## 5. Riesgos y Mitigaciones',
                '- …',
                '',
                '## 6. Evidencias',
                '- …',
                '',
                '## 7. Historial por Ambiente',
                '- **Desarrollo**: fecha, quién, evidencia',
                '- **QA**: fecha, quién, evidencia',
                '- **Producción**: fecha, quién, evidencia',
                ''
              ].join('\n');
            } else {
              bodyMd = [
                `# Plan/Acta de Pruebas: ${issue.title}`,
                '',
                '## 1. Objetivos',
                objetivo || '',
                '',
                '## 2. Alcance y Preparación',
                alcance || '',
                '',
                '## 3. Casos de Prueba',
                (casos || `| ID | Título | Pasos | Esperado |
|----|--------|-------|----------|
| CP-01 | … | … | … |`),
                '',
                '## 4. Resultados',
                resultados || '- CP-01: ✅ / ❌ — Evidencia: …',
                '',
                '## 5. Incidencias',
                incidencias || '- BUG-001: …',
                '',
                '## 6. Conclusiones',
                '- Checklist de aceptación: …',
                ''
              ].join('\n');
            }

            const content = fm + '\n' + bodyMd;

            // ---------- rama por defecto ----------
            const { data: repoInfo } = await github.repos.get({ owner, repo });
            const defaultBranch = repoInfo.default_branch;

            // ---------- existe? obtener SHA ----------
            let sha;
            try {
              const res = await github.repos.getContent({ owner, repo, path, ref: defaultBranch });
              if (!Array.isArray(res.data)) sha = res.data.sha;
            } catch (_) {
              // 404 -> crear
            }

            const message = sha
              ? `docs: update ${codigo} from issue #${issue.number}`
              : `docs: create ${codigo} from issue #${issue.number}`;

            await github.repos.createOrUpdateFileContents({
              owner, repo,
              path,
              message,
              content: Buffer.from(content, 'utf8').toString('base64'),
              branch: defaultBranch,
              sha
            });

            const url = `https://github.com/${owner}/${repo}/blob/${defaultBranch}/${path}`;
            await github.issues.createComment({
              owner, repo, issue_number: issue.number,
              body: `📄 Se ${sha ? 'actualizó' : 'creó'} el documento **${codigo}**:\n\n- Ruta: \`${path}\`\n- Link: ${url}`
            });
``