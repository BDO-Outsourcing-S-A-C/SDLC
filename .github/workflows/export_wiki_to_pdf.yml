name: Build Wiki PDF

on:
    workflow_dispatch:
        inputs:
            include_toc:
                description: "Incluir tabla de contenidos generada"
                type: boolean
                default: true
            publish_release:
                description: "Publicar PDF en un release (si es true y se especifica tag)"
                type: boolean
                default: false
            release_tag:
                description: "Tag para el release (por ejemplo v-wiki-latest)"
                required: false
            page_break_style:
                description: "Estilo de corte de página: newpage | pagebreak | none | hr"
                required: false
                default: newpage
    schedule:
        - cron: "0 3 * * *"

jobs:
    build-wiki-pdf:
        runs-on: ubuntu-latest
        steps:
            - name: Checkout (main repo)
              uses: actions/checkout@v4

            - name: Clonar wiki
              run: |
                  set -e
                  git clone https://github.com/BDO-Outsourcing-S-A-C/SDLC.wiki.git wiki
                  ls -1 wiki

            - name: Instalar dependencias (pandoc + LaTeX)
              run: |
                  sudo apt-get update
                  sudo apt-get install -y pandoc texlive texlive-latex-extra texlive-fonts-recommended

            - name: Preparar script de conversión
              run: |
                  mkdir -p scripts
                  cat > scripts/convert-wiki-to-pdf.sh <<'EOF'
                  #!/usr/bin/env bash
                  set -euo pipefail

                  WIKI_DIR="wiki"
                  OUTPUT_DIR="dist"
                  OUTPUT_FILE="wiki.pdf"
                  ORDER_FILE="_order.txt"

                  mkdir -p "$OUTPUT_DIR"

                  if [[ -f "$WIKI_DIR/$ORDER_FILE" ]]; then
                    echo "Usando orden manual: $ORDER_FILE"
                    mapfile -t FILES < <(grep -v '^\s*$' "$WIKI_DIR/$ORDER_FILE")
                  else
                    echo "Sin _order.txt; generando orden por defecto."
                    if [[ -f "$WIKI_DIR/Home.md" ]]; then
                      FIRST="Home.md"
                    else
                      FIRST=""
                    fi
                    mapfile -t ALL < <(cd "$WIKI_DIR" && ls -1 *.md | sort)
                    FILES=()
                    if [[ -n "$FIRST" ]]; then
                      FILES+=( "$FIRST" )
                      for f in "${ALL[@]}"; do
                        [[ "$f" == "$FIRST" ]] && continue
                        FILES+=( "$f" )
                      done
                    else
                      FILES=( "${ALL[@]}" )
                    fi
                  fi

                  echo "Archivos:"
                  printf ' - %s\n' "${FILES[@]}"

                  CONCAT="$OUTPUT_DIR/combined.md"
                  {
                    echo "# Documentación de la Wiki"
                    echo ""
                    echo "Generado automáticamente: $(date -u +"%Y-%m-%d %H:%M:%S UTC")"
                    echo ""
                  } > "$CONCAT"

                  INCLUDE_TOC="${INCLUDE_TOC:-true}"
                  PAGE_BREAK_STYLE="${PAGE_BREAK_STYLE:-newpage}"
                  # Estilos posibles:
                  # newpage   => inserta \newpage (LaTeX)
                  # pagebreak => inserta \pagebreak (LaTeX)
                  # hr        => inserta '---' (línea horizontal, NO corte real)
                  # none      => no inserta separador

                  add_page_break () {
                    local style="$1"
                    case "$style" in
                      newpage)
                        echo "" >> "$CONCAT"
                        echo "\\newpage" >> "$CONCAT"
                        echo "" >> "$CONCAT"
                        ;;
                      pagebreak)
                        echo "" >> "$CONCAT"
                        echo "\\pagebreak" >> "$CONCAT"
                        echo "" >> "$CONCAT"
                        ;;
                      hr)
                        echo "" >> "$CONCAT"
                        echo "---" >> "$CONCAT"
                        echo "" >> "$CONCAT"
                        ;;
                      none|*)
                        # Nada
                        ;;
                    esac
                  }

                  if [[ "$INCLUDE_TOC" == "true" ]]; then
                    # Usaremos el TOC nativo de pandoc con --toc, así que no colocamos [TOC] aquí
                    echo "" >> "$CONCAT"
                  fi

                  TOTAL=${#FILES[@]}
                  for i in "${!FILES[@]}"; do
                    f="${FILES[$i]}"
                    echo "" >> "$CONCAT"
                    echo "<!-- File: $f -->" >> "$CONCAT"
                    # Agregar título del archivo (si el archivo no tiene heading principal)
                    # Detectar si comienza con '#'
                    if ! grep -q '^#' "$WIKI_DIR/$f"; then
                      base_title="${f%.md}"
                      echo "# $base_title" >> "$CONCAT"
                      echo "" >> "$CONCAT"
                    fi
                    cat "$WIKI_DIR/$f" >> "$CONCAT"
                    # Insertar separador si no es el último
                    if (( i < TOTAL - 1 )); then
                      add_page_break "$PAGE_BREAK_STYLE"
                    fi
                  done

                  echo "Convirtiendo a PDF..."
                  if [[ "$INCLUDE_TOC" == "true" ]]; then
                    pandoc "$CONCAT" --toc -V geometry:margin=2cm -o "$OUTPUT_DIR/$OUTPUT_FILE"
                  else
                    pandoc "$CONCAT" -V geometry:margin=2cm -o "$OUTPUT_DIR/$OUTPUT_FILE"
                  fi

                  echo "PDF listo: $OUTPUT_DIR/$OUTPUT_FILE"
                  EOF
                  chmod +x scripts/convert-wiki-to-pdf.sh

            - name: Ejecutar conversión
              env:
                  INCLUDE_TOC: ${{ inputs.include_toc }}
                  PAGE_BREAK_STYLE: ${{ inputs.page_break_style }}
              run: |
                  ./scripts/convert-wiki-to-pdf.sh

            - name: Subir artefacto
              uses: actions/upload-artifact@v4
              with:
                  name: wiki-pdf
                  path: dist/wiki.pdf
                  retention-days: 14

            - name: Publicar release (opcional)
              if: ${{ inputs.publish_release == true && inputs.release_tag != '' }}
              uses: softprops/action-gh-release@v2
              with:
                  tag_name: ${{ inputs.release_tag }}
                  name: "Wiki PDF ${{ inputs.release_tag }}"
                  files: dist/wiki.pdf
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
