name: Build Wiki PDF

on:
  workflow_dispatch:
    inputs:
      include_toc:
        description: "Incluir tabla de contenidos generada"
        type: boolean
        default: true
      publish_release:
        description: "Publicar PDF en un release (si es true y se especifica tag)"
        type: boolean
        default: false
      release_tag:
        description: "Tag para el release (por ejemplo v-wiki-latest)"
        required: false
  schedule:
    - cron: "0 3 * * *"  # Todos los días a las 03:00 UTC

jobs:
  build-wiki-pdf:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout (main repo)
        uses: actions/checkout@v4

      - name: Clonar wiki
        run: |
          set -e
          git clone https://github.com/BDO-Outsourcing-S-A-C/SDLC.wiki.git wiki
          echo "Contenido clonado:"
          ls -1 wiki

      - name: Instalar dependencias (pandoc + LaTeX)
        run: |
          sudo apt-get update
            # Paquetes mínimos. Si necesitas mejor tipografía añade: texlive-fonts-extra
          sudo apt-get install -y pandoc texlive texlive-latex-extra texlive-fonts-recommended

      - name: Preparar script de conversión
        run: |
          mkdir -p scripts
          cat > scripts/convert-wiki-to-pdf.sh <<'EOF'
          #!/usr/bin/env bash
          set -euo pipefail

          WIKI_DIR="wiki"
          OUTPUT_DIR="dist"
          OUTPUT_FILE="wiki.pdf"

          ORDER_FILE="_order.txt"

          mkdir -p "$OUTPUT_DIR"

          # Si existe archivo de orden manual úsalo:
          if [[ -f "$WIKI_DIR/$ORDER_FILE" ]]; then
            echo "Usando orden manual definido en $ORDER_FILE"
            mapfile -t FILES < <(grep -v '^\s*$' "$WIKI_DIR/$ORDER_FILE")
          else
            echo "No hay _order.txt; generando orden por defecto (Home.md primero si existe)"
            # Tomar Home.md primero si existe y luego el resto alfabético
            if [[ -f "$WIKI_DIR/Home.md" ]]; then
              FIRST="Home.md"
            else
              FIRST=""
            fi
            mapfile -t ALL < <(cd "$WIKI_DIR" && ls -1 *.md | sort)
            FILES=()
            if [[ -n "$FIRST" ]]; then
              FILES+=( "$FIRST" )
              for f in "${ALL[@]}"; do
                [[ "$f" == "$FIRST" ]] && continue
                FILES+=( "$f" )
              done
            else
              FILES=( "${ALL[@]}" )
            fi
          fi

          echo "Archivos seleccionados:"
          printf ' - %s\n' "${FILES[@]}"

          # Crear un archivo temporal concatenado para tener control sobre portada/TOC
          CONCAT="$OUTPUT_DIR/combined.md"

          # Portada simple
          {
            echo "# Documentación de la Wiki"
            echo ""
            echo "Generado automáticamente: $(date -u +"%Y-%m-%d %H:%M:%S UTC")"
            echo ""
          } > "$CONCAT"

          INCLUDE_TOC="${INCLUDE_TOC:-true}"

          if [[ "$INCLUDE_TOC" == "true" ]]; then
            echo "[TOC]" >> "$CONCAT"
            echo "" >> "$CONCAT"
          fi

            # Unir contenido (podrías insertar separadores)
          for f in "${FILES[@]}"; do
            echo "" >> "$CONCAT"
            echo "<!-- File: $f -->" >> "$CONCAT"
            cat "$WIKI_DIR/$f" >> "$CONCAT"
            echo "" >> "$CONCAT"
          done

          # Convertir con pandoc
          # -V geometry para márgenes, -V toc si se usa TOC nativo de pandoc (alternativa a [TOC])
          # Nota: El marcador [TOC] es manejado por algunos filtros; para pandoc puro puedes usar --toc
          if [[ "$INCLUDE_TOC" == "true" ]]; then
            pandoc "$CONCAT" --toc -V geometry:margin=2cm -o "$OUTPUT_DIR/$OUTPUT_FILE"
          else
            pandoc "$CONCAT" -V geometry:margin=2cm -o "$OUTPUT_DIR/$OUTPUT_FILE"
          fi

          echo "PDF generado en $OUTPUT_DIR/$OUTPUT_FILE"
          EOF
          chmod +x scripts/convert-wiki-to-pdf.sh

      - name: Ejecutar conversión
        env:
          INCLUDE_TOC: ${{ inputs.include_toc }}
        run: |
          ./scripts/convert-wiki-to-pdf.sh

      - name: Subir artefacto
        uses: actions/upload-artifact@v4
        with:
          name: wiki-pdf
          path: dist/wiki.pdf
          retention-days: 14

      - name: Publicar release (opcional)
        if: ${{ inputs.publish_release == true && inputs.release_tag != '' }}
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ inputs.release_tag }}
          name: "Wiki PDF ${{ inputs.release_tag }}"
          files: dist/wiki.pdf
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}